<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Master Item | Juragan Buah</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="../css/styles.css">
  <script src="../js/utils.js"></script>
  <script src="../js/data.js"></script>
</head>

<body>
  <!-- HEADER -->
  <header class="topbar">
    <div class="brand">
      <img src="../assets/logo.png" class="logo">
      <span>Juragan Buah</span>
    </div>
    <a href="dashboard.html" class="btn btn-light">‚¨Ö Dashboard</a>
  </header>

  <!-- CONTENT -->
  <main class="container">
    <div class="card">
      <div class="card-header">
        <h2>üçé Master Item</h2>
        <button class="btn btn-green" onclick="openModal()">+ Tambah Item</button>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Gambar</th>
              <th>Nama</th>
              <th>Barcode</th>
              <th>Harga</th>
              <th>Stok</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="itemTable"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- MODAL -->
  <div class="modal" id="itemModal">
    <div class="modal-content">
      <h3 id="modalTitle">Tambah Item</h3>

      <input type="hidden" id="itemId">

      <label>Nama Item</label>
      <input id="itemName">

      <label>Harga Jual</label>
      <input type="number" id="itemPrice">

      <label>Stok Awal</label>
      <input type="number" id="itemStock">

      <label>Barcode</label>
      <input id="itemBarcode" placeholder="Opsional">

      <label>Gambar Produk</label>
      <input type="file" id="itemImage" accept="image/*">

      <label>Satuan Dasar (contoh: pcs / g)</label>
      <input id="itemUnitBase" value="pcs">

      <label>Konversi Satuan</label>
      <textarea id="itemUnitConv" placeholder="kg=1000"></textarea>

      <div class="modal-actions">
        <button class="btn btn-green" onclick="saveItem()">üíæ Simpan</button>
        <button class="btn btn-red" onclick="closeModal()">Batal</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   LOAD DATA
========================= */
function loadItems() {
  const tbody = document.getElementById("itemTable");
  tbody.innerHTML = "";

  DataStore.getItems().forEach(item => {
    tbody.innerHTML += `
      <tr>
        <td>
          ${item.image ? `<img src="${item.image}" class="thumb">` : "-"}
        </td>
        <td>${item.name}</td>
        <td>${item.barcode || "-"}</td>
        <td>${formatRupiah(item.price)}</td>
        <td>${item.stock}</td>
        <td>
          <button class="btn btn-small" onclick="editItem('${item.id}')">‚úèÔ∏è</button>
          <button class="btn btn-small btn-red" onclick="deleteItem('${item.id}')">üóë</button>
        </td>
      </tr>`;
  });
}

/* =========================
   MODAL
========================= */
function openModal() {
  document.getElementById("itemModal").style.display = "flex";
}

function closeModal() {
  document.getElementById("itemModal").style.display = "none";
  document.querySelectorAll("#itemModal input, textarea").forEach(i => i.value = "");
  document.getElementById("itemUnitBase").value = "pcs";
}

/* =========================
   CRUD
========================= */
async function saveItem() {
  const id = itemId.value;
  const name = itemName.value.trim();
  const price = Number(itemPrice.value);
  const stock = Number(itemStock.value);
  const barcode = itemBarcode.value.trim();
  const unitBase = itemUnitBase.value.trim();

  const conv = itemUnitConv.value.split("\n").map(l => {
    const [u, f] = l.split("=");
    if (!u || !f) return null;
    return { unit: u.trim(), factor: Number(f) };
  }).filter(Boolean);

  let imageData = null;
  if (itemImage.files[0]) {
    imageData = await readFileAsDataURL(itemImage.files[0]);
  }

  if (id) {
    DataStore.updateItem(id, { name, price, stock, barcode, image: imageData, unitBase, unitConversions: conv });
  } else {
    DataStore.addItem({ name, price, stock, barcode, image: imageData, unitBase, unitConversions: conv });
  }

  closeModal();
  loadItems();
}

function editItem(id) {
  const item = DataStore.getItems().find(i => i.id === id);
  if (!item) return;

  itemId.value = item.id;
  itemName.value = item.name;
  itemPrice.value = item.price;
  itemStock.value = item.stock;
  itemBarcode.value = item.barcode || "";
  itemUnitBase.value = item.unitBase || "pcs";
  itemUnitConv.value = (item.unitConversions || [])
    .map(u => `${u.unit}=${u.factor}`).join("\n");

  openModal();
}

function deleteItem(id) {
  if (confirm("Hapus item ini?")) {
    DataStore.deleteItem(id);
    loadItems();
  }
}

document.addEventListener("DOMContentLoaded", loadItems);
</script>

</body>
</html>
