<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard | Juragan Buah POS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- STYLE -->
<link rel="stylesheet" href="../css/styles.css">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- CORE JS -->
<script src="../js/data.js"></script>
<script src="../js/auth.js"></script>
<script src="../js/permissions.js"></script>
<script src="../js/cloud.js"></script>
<script src="../js/sidebar.js"></script>
</head>

<body>

<script>
/* ===== AUTH PROTECT ===== */
Auth.requireLogin();
</script>

<div class="app">

  <!-- ================= SIDEBAR ================= -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <img src="../assets/logo.png" alt="Logo">
      <span>Juragan Buah POS</span>
    </div>

    <ul class="menu">

      <!-- DASHBOARD -->
      <li>
        <a class="active" href="dashboard.html">ğŸ  Dashboard</a>
      </li>

      <!-- MASTER -->
      <li class="menu-title">MASTER</li>
      <li data-role="admin">
        <a href="items.html">ğŸ“¦ Master Item</a>
      </li>
      <li data-role="admin">
        <a href="buyers.html">ğŸ‘¤ Pembeli</a>
      </li>

      <!-- STOK -->
      <li class="menu-title">PERSEDIAAN</li>
      <li data-role="admin">
        <a href="stock-in.html">â¬‡ï¸ Item Masuk</a>
      </li>
      <li data-role="admin">
        <a href="stock-out.html">â¬†ï¸ Item Keluar</a>
      </li>
      <li data-role="admin">
        <a href="opname.html">ğŸ“ Stok Opname</a>
      </li>

      <!-- TRANSAKSI -->
      <li class="menu-title">TRANSAKSI</li>
      <li data-role="admin,kasir">
        <a href="sales.html">ğŸ§¾ Penjualan (Kasir)</a>
      </li>

      <!-- LAPORAN -->
      <li class="menu-title">LAPORAN</li>
      <li data-role="admin">
        <a href="report-sales.html">ğŸ“Š Laporan Penjualan</a>
      </li>
      <li data-role="admin">
        <a href="report-stock.html">ğŸ“¦ Laporan Persediaan</a>
      </li>
      <li data-role="admin">
        <a href="report-profit.html">ğŸ’° Laba Rugi</a>
      </li>

      <!-- USER -->
      <li class="menu-title">SYSTEM</li>
      <li data-role="admin">
        <a href="users.html">ğŸ‘¥ Manajemen User</a>
      </li>

      <li>
        <a href="#" onclick="Auth.logout()">ğŸšª Logout</a>
      </li>

    </ul>
  </aside>

  <!-- ================= CONTENT ================= -->
  <main class="content">

    <!-- HEADER -->
    <header class="content-header">
      <button id="sidebarToggle">â˜°</button>
      <span id="currentUser"></span>
    </header>

    <!-- DASHBOARD BODY -->
    <div class="dashboard">

      <!-- SUMMARY -->
      <div class="cards">
        <div class="card green">
          <h4>Total Penjualan</h4>
          <h2 id="totalSales">Rp 0</h2>
        </div>

        <div class="card blue">
          <h4>Total Transaksi</h4>
          <h2 id="totalTrx">0</h2>
        </div>
      </div>

      <!-- CHART -->
      <div class="card chart-card">
        <h4>Grafik Penjualan</h4>
        <canvas id="salesChart" height="120"></canvas>
      </div>

    </div>
  </main>
</div>

<!-- ================= SCRIPT ================= -->
<script>
/* =========================
   REALTIME DASHBOARD
========================= */

let chart;

function initChart(labels = [], data = []) {
  const ctx = document.getElementById("salesChart").getContext("2d");
  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        data,
        borderColor: "#16a34a",
        backgroundColor: "rgba(22,163,74,.2)",
        fill: true,
        tension: .3
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } }
    }
  });
}

CloudStore.onSalesChange(sales => {
  let total = 0;
  let labels = [];
  let values = [];

  sales.forEach(s => {
    total += s.total || 0;
    const date = s.createdAt?.toDate
      ? s.createdAt.toDate().toLocaleDateString("id-ID")
      : "Hari Ini";

    const i = labels.indexOf(date);
    if (i === -1) {
      labels.push(date);
      values.push(s.total || 0);
    } else {
      values[i] += s.total || 0;
    }
  });

  document.getElementById("totalSales").innerText =
    "Rp " + total.toLocaleString("id-ID");
  document.getElementById("totalTrx").innerText = sales.length;

  initChart(labels, values);
});
</script>

</body>
</html>
