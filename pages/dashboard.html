<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard | Juragan Buah POS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- STYLE -->
<link rel="stylesheet" href="../css/styles.css">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- CORE JS -->
<script src="../js/data.js"></script>
<script src="../js/auth.js"></script>
<script src="../js/permissions.js"></script>
<script src="../js/cloud.js"></script>
<script src="../js/sidebar.js"></script>
</head>

<body>

<script>
/* =========================
   LOGIN PROTECTION
========================= */
Auth.requireLogin();
</script>

<div class="app">

  <!-- ================= SIDEBAR ================= -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <img src="../assets/logo.png" alt="Logo">
      <span>Juragan Buah</span>
    </div>

    <ul class="menu">
      <li>
        <a class="active" href="dashboard.html">üè† Dashboard</a>
      </li>

      <li data-role="admin">
        <a href="items.html">üì¶ Master Item</a>
      </li>

      <li data-role="admin">
        <a href="stock-in.html">‚¨áÔ∏è Item Masuk</a>
      </li>

      <li data-role="admin">
        <a href="stock-out.html">‚¨ÜÔ∏è Item Keluar</a>
      </li>

      <li data-role="admin,kasir">
        <a href="sales.html">üßæ Kasir</a>
      </li>

      <li data-role="admin">
        <a href="users.html">üë• User</a>
      </li>

      <li>
        <a href="#" onclick="Auth.logout()">üö™ Logout</a>
      </li>
    </ul>
  </aside>

  <!-- ================= CONTENT ================= -->
  <main class="content">

    <!-- HEADER -->
    <header class="content-header">
      <button id="sidebarToggle">‚ò∞</button>
      <span id="currentUser"></span>
    </header>

    <!-- DASHBOARD BODY -->
    <div class="dashboard">

      <!-- SUMMARY -->
      <div class="cards">
        <div class="card green">
          <h4>Total Penjualan</h4>
          <h2 id="totalSales">Rp 0</h2>
        </div>

        <div class="card blue">
          <h4>Total Transaksi</h4>
          <h2 id="totalTrx">0</h2>
        </div>
      </div>

      <!-- CHART -->
      <div class="card chart-card">
        <h4>Grafik Penjualan</h4>
        <canvas id="salesChart" height="120"></canvas>
      </div>

    </div>
  </main>
</div>

<!-- ================= SCRIPT ================= -->
<script>
/* =========================
   REALTIME DASHBOARD
========================= */

let chart;

/* Init chart */
function initChart(labels = [], data = []) {
  const ctx = document.getElementById("salesChart").getContext("2d");

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "Penjualan",
        data,
        borderColor: "#16a34a",
        backgroundColor: "rgba(22,163,74,.2)",
        fill: true,
        tension: .3
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } }
    }
  });
}

/* Load realtime sales */
CloudStore.onSalesChange(sales => {
  let total = 0;
  let labels = [];
  let values = [];

  sales.forEach(s => {
    total += s.total || 0;

    const date = s.createdAt?.toDate
      ? s.createdAt.toDate().toLocaleDateString("id-ID")
      : "Hari Ini";

    const idx = labels.indexOf(date);
    if (idx === -1) {
      labels.push(date);
      values.push(s.total || 0);
    } else {
      values[idx] += s.total || 0;
    }
  });

  document.getElementById("totalSales").innerText =
    "Rp " + total.toLocaleString("id-ID");

  document.getElementById("totalTrx").innerText = sales.length;

  initChart(labels, values);
});
</script>

</body>
</html>
