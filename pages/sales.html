<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Kasir | Juragan Buah</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="../css/styles.css">
<script src="../js/utils.js"></script>
<script src="../js/data.js"></script>
</head>

<body>

<header class="topbar">
  <div class="brand">
    <img src="../assets/logo.png" class="logo">
    <span>Juragan Buah ‚Äî Kasir</span>
  </div>
  <a href="dashboard.html" class="btn btn-light">‚¨Ö Dashboard</a>
</header>

<main class="container kasir-layout">

<!-- ================= LEFT ================= -->
<section class="kasir-left card">
  <h3>üõí Tambah Produk</h3>

  <label>Scan Barcode</label>
  <input id="barcodeInput" placeholder="Scan barcode">

  <label>Pilih Produk</label>
  <select id="itemSelect"></select>

  <label>Qty</label>
  <input type="number" id="qtyInput" value="1" min="1">

  <button class="btn btn-green" onclick="addToCart()">+ Tambah</button>

  <hr>

  <h4>Keranjang</h4>
  <table class="cart-table">
    <thead>
      <tr>
        <th>Item</th>
        <th>Qty</th>
        <th>Total</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="cartTable"></tbody>
  </table>
</section>

<!-- ================= RIGHT ================= -->
<section class="kasir-right card">
  <h3>üí≥ Pembayaran</h3>

  <label>Pembeli</label>
  <select id="buyerSelect"></select>

  <label>Metode Pembayaran</label>
  <select id="paymentMethod">
    <option value="Tunai">Tunai</option>
    <option value="Transfer">Transfer</option>
    <option value="QRIS">QRIS</option>
  </select>

  <label>Total</label>
  <input id="totalDisplay" readonly>

  <label>Bayar</label>
  <input type="number" id="payInput">

  <label>Kembalian</label>
  <input id="changeDisplay" readonly>

  <button class="btn btn-green btn-big" onclick="processPayment()">‚úî Bayar</button>
</section>

</main>

<!-- ================= STRUK ================= -->
<div id="receipt" class="receipt">
  <h3>üßæ Juragan Buah</h3>
  <p id="receiptInfo"></p>
  <table id="receiptTable"></table>
  <p id="receiptTotal"></p>
</div>

<script>
let cart = [];

/* ================= INIT ================= */
function init() {
  const itemSel = itemSelect;
  DataStore.getItems().forEach(i => {
    if (i.stock > 0) {
      itemSel.innerHTML += `<option value="${i.id}">${i.name} (${i.stock})</option>`;
    }
  });

  buyerSelect.innerHTML = "";
  DataStore.getBuyers().forEach(b => {
    buyerSelect.innerHTML += `<option value="${b.name}">${b.name}</option>`;
  });

  totalDisplay.value = "Rp 0";
}
init();

/* ================= BARCODE ================= */
barcodeInput.addEventListener("change", () => {
  const code = barcodeInput.value.trim();
  const item = DataStore.getItems().find(i => i.barcode === code);
  if (item) itemSelect.value = item.id;
});

/* ================= CART ================= */
function addToCart() {
  const itemId = itemSelect.value;
  const qty = Number(qtyInput.value);
  if (!itemId || qty <= 0) return;

  const item = DataStore.getItems().find(i => i.id === itemId);
  if (qty > item.stock) return alert("Stok tidak cukup");

  const existing = cart.find(c => c.id === itemId);
  if (existing) existing.qty += qty;
  else cart.push({ id:itemId, name:item.name, price:item.price, qty });

  renderCart();
}

function renderCart() {
  cartTable.innerHTML = "";
  let total = 0;

  cart.forEach((c, i) => {
    const sub = c.qty * c.price;
    total += sub;

    cartTable.innerHTML += `
      <tr>
        <td>${c.name}</td>
        <td>${c.qty}</td>
        <td>${formatRupiah(sub)}</td>
        <td><button onclick="removeCart(${i})">‚ùå</button></td>
      </tr>`;
  });

  totalDisplay.value = formatRupiah(total);
}

function removeCart(i) {
  cart.splice(i,1);
  renderCart();
}

/* ================= PAYMENT ================= */
payInput.addEventListener("input", () => {
  const pay = Number(payInput.value);
  const total = cart.reduce((a,c)=>a+c.qty*c.price,0);
  changeDisplay.value = formatRupiah(pay - total);
});

function processPayment() {
  if (cart.length === 0) return alert("Keranjang kosong");

  const total = cart.reduce((a,c)=>a+c.qty*c.price,0);
  const pay = Number(payInput.value);
  if (pay < total) return alert("Pembayaran kurang");

  const items = DataStore.getItems();
  cart.forEach(c => {
    const it = items.find(i => i.id === c.id);
    it.stock -= c.qty;
  });
  DataStore.saveItems(items);

  DataStore.saveSales([...DataStore.getSales(), {
    date: new Date().toLocaleString(),
    buyer: buyerSelect.value,
    method: paymentMethod.value,
    total,
    items: cart
  }]);

  printReceipt(total);
  cart = [];
  renderCart();
}

/* ================= RECEIPT ================= */
function printReceipt(total) {
  receipt.style.display = "block";
  receiptInfo.innerText = `Pembeli: ${buyerSelect.value}\nMetode: ${paymentMethod.value}`;
  receiptTable.innerHTML = cart.map(c =>
    `<tr><td>${c.name}</td><td>${c.qty}</td><td>${formatRupiah(c.qty*c.price)}</td></tr>`
  ).join("");
  receiptTotal.innerHTML = `<b>Total: ${formatRupiah(total)}</b>`;
  window.print();
}
</script>

</body>
</html>
