<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Kasir | Juragan Buah POS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="../css/styles.css">

<!-- CORE -->
<script src="../js/auth.js"></script>
<script src="../js/cloud.js"></script>
<script src="../js/sidebar.js"></script>
</head>

<body>
<script>Auth.requireLogin();</script>

<div class="app">

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-header">
    <img src="../assets/logo.png">
    <span>Juragan Buah</span>
  </div>
  <ul class="menu">
    <li><a href="dashboard.html">üè† Dashboard</a></li>
    <li><a class="active" href="sales.html">üßæ Kasir</a></li>
    <li><a onclick="Auth.logout()">üö™ Logout</a></li>
  </ul>
</aside>

<!-- CONTENT -->
<main class="content">

<header class="content-header">
  <button id="sidebarToggle">‚ò∞</button>
  <strong>SUPER KASIR</strong>
</header>

<!-- POS GRID -->
<div style="display:grid;grid-template-columns:2fr 1.2fr;gap:16px">

<!-- PRODUK -->
<script src="../js/barcode.js"></script>

<form onsubmit="saveItem(event)">
  <input id="name" placeholder="Nama Item" required>
  <input id="price" type="number" placeholder="Harga" required>

  <input id="barcode" placeholder="Barcode" readonly>
  <button type="button" onclick="genBarcode()">Generate Barcode</button>

  <input id="image" type="file" accept="image/*">

  <button class="btn btn-green">Simpan</button>
</form>

<script>
function genBarcode() {
  barcode.value = BarcodeUtil.generate();
}

function saveItem(e) {
  e.preventDefault();

  const reader = new FileReader();
  const file = image.files[0];

  reader.onload = () => {
    CloudStore.saveItem({
      name: name.value,
      price: Number(price.value),
      barcode: barcode.value,
      image: reader.result,
      stock: 0
    });
    alert("Item tersimpan");
    e.target.reset();
  };

  if (file) reader.readAsDataURL(file);
  else reader.onload();
}
</script>

<!-- KERANJANG -->
<div class="card">
  <h4>Keranjang</h4>
  <div id="cart"></div>

  <hr>

  <h2>Total: <span id="grandTotal">Rp 0</span></h2>

  <label>Metode Bayar</label>
  <select id="payMethod">
    <option>Tunai</option>
    <option>QRIS</option>
    <option>Transfer</option>
  </select>

  <label>Bayar</label>
  <input id="payAmount" type="number">

  <p>Kembali: <strong id="change">Rp 0</strong></p>

  <button class="btn btn-green" onclick="checkout()">üíæ BAYAR & CETAK</button>
</div>

</div>
</main>
</div>

<script>
let items = [];
let cart = [];

/* LOAD PRODUK */
CloudStore.getItems().then(data => {
  items = data;
  renderProducts();
});

/* RENDER PRODUK */
function renderProducts() {
  const tbody = document.getElementById("productList");
  tbody.innerHTML = "";
  items.forEach(i => {
    tbody.innerHTML += `
      <tr>
        <td>${i.name}</td>
        <td>Rp ${i.price.toLocaleString()}</td>
        <td>
          <button class="btn btn-blue" onclick="addItem('${i.id}')">+</button>
        </td>
      </tr>`;
  });
}

/* TAMBAH KE KERANJANG */
function addItem(id) {
  const item = items.find(i => i.id === id);
  let row = cart.find(c => c.id === id);

  if (row) row.qty++;
  else cart.push({ ...item, qty: 1 });

  renderCart();
}

/* RENDER KERANJANG */
function renderCart() {
  const div = document.getElementById("cart");
  div.innerHTML = "";
  let total = 0;

  cart.forEach((c, i) => {
    const sub = c.qty * c.price;
    total += sub;
    div.innerHTML += `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>${c.name}</strong><br>
          Rp ${c.price.toLocaleString()} x ${c.qty}
        </div>
        <div>
          <button onclick="qty(${i},-1)">‚àí</button>
          <button onclick="qty(${i},1)">+</button>
        </div>
      </div>
      <hr>`;
  });

  document.getElementById("grandTotal").innerText =
    "Rp " + total.toLocaleString();

  payAmount.oninput = () => {
    change.innerText =
      "Rp " + (payAmount.value - total).toLocaleString();
  };
}

/* QTY */
function qty(i, d) {
  cart[i].qty += d;
  if (cart[i].qty <= 0) cart.splice(i, 1);
  renderCart();
}

/* BARCODE */
barcodeInput.addEventListener("change", e => {
  const code = e.target.value.trim();
  const found = items.find(i => i.barcode === code);
  if (found) addItem(found.id);
  barcodeInput.value = "";
});

/* CHECKOUT */
<script>
function checkout() {
  if (!cart.length) return alert("Keranjang kosong");

  const total = cart.reduce((s,c)=>s+c.qty*c.price,0);
  const bayar = Number(payAmount.value||0);
  if (bayar < total && payMethod.value==="Tunai")
    return alert("Uang kurang");

  const sale = {
    items: cart,
    total,
    bayar,
    metode: payMethod.value,
    kasir: Auth.getUser().username,
    waktu: new Date().toISOString()
  };

  CloudStore.saveSale(sale);

  localStorage.setItem("printSale", JSON.stringify(sale));

  window.open("invoice.html","_blank");

  cart=[];
  renderCart();
}
</script>

/* STRUK */
function printStruk(total) {
  const w = window.open("", "", "width=280,height=600");
  w.document.write(`<pre>
JURAGAN BUAH
------------------
${cart.map(c=>`${c.name} x${c.qty}`).join("\n")}
------------------
TOTAL : ${total}
${payMethod.value}
------------------
Terima kasih
</pre>`);
  w.print(); w.close();
}
</script>

</body>
</html>


