<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>Kasir | Juragan Buah</title>

  <link rel="stylesheet" href="../css/styles.css" />
  <script src="../js/data.js"></script>
  <script src="../js/auth.js"></script>
</head>

<body>

<!-- ================= TOPBAR ================= -->
<div class="topbar">
  <div class="logo">
    <img src="../assets/logo.png" alt="Juragan Buah">
    <strong>Juragan Buah â€” Kasir</strong>
  </div>
  <nav>
    <a href="dashboard.html">Dashboard</a>
    <a href="items.html">Item</a>
    <a href="buyers.html">Pembeli</a>
    <a href="sales.html" class="active">Penjualan</a>
    <a href="#" onclick="logout()">Logout</a>
  </nav>
</div>

<!-- ================= CONTENT ================= -->
<div class="container">

  <!-- ADD ITEM -->
  <div class="card">
    <h3>Tambah Produk</h3>
    <select id="itemSelect"></select>
    <input type="number" id="qty" placeholder="Qty" value="1">
    <button id="addItemBtn" type="button" class="btn btn-green">Tambah</button>
  </div>

  <!-- CART -->
  <div class="card">
    <h3>Keranjang</h3>
    <table class="table" id="cartTable">
      <thead>
        <tr>
          <th>Item</th>
          <th>Qty</th>
          <th>Harga</th>
          <th>Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <h3>Total: Rp <span id="grandTotal">0</span></h3>
  </div>

  <!-- PAYMENT -->
  <div class="card">
    <h3>Pembayaran</h3>
    <select id="paymentMethod">
      <option value="Cash">Cash</option>
      <option value="Transfer">Transfer</option>
      <option value="QRIS">QRIS</option>
    </select>

    <div id="qrisBox" style="display:none; text-align:center">
      <img src="../assets/qris.png" style="max-width:200px">
      <p>Scan QRIS</p>
    </div>

    <input type="number" id="paid" placeholder="Uang Dibayar">
    <p>Kembalian: Rp <span id="change">0</span></p>

    <button id="payBtn" type="button" class="btn btn-green btn-big">Simpan Transaksi</button>
    <button id="printBtn" type="button" class="btn btn-blue btn-big">Print Struk</button>
  </div>

</div>

<!-- ================= SCRIPT ================= -->
<script>
let cart = [];

const items = DataStore.getItems();
const itemSelect = document.getElementById("itemSelect");
const cartBody = document.querySelector("#cartTable tbody");

items.forEach(i => {
  itemSelect.innerHTML += `<option value="${i.id}">${i.name} - Rp ${i.price}</option>`;
});

document.getElementById("addItemBtn").onclick = () => {
  const item = items.find(i => i.id === itemSelect.value);
  const qty = parseInt(document.getElementById("qty").value);

  if (!item || qty <= 0) return;

  cart.push({
    name: item.name,
    price: item.price,
    qty
  });

  renderCart();
};

function renderCart() {
  cartBody.innerHTML = "";
  let total = 0;

  cart.forEach((c, index) => {
    const sub = c.qty * c.price;
    total += sub;

    cartBody.innerHTML += `
      <tr>
        <td>${c.name}</td>
        <td>${c.qty}</td>
        <td>${c.price}</td>
        <td>${sub}</td>
        <td>
          <button type="button" class="btn btn-red btn-sm" onclick="removeItem(${index})">X</button>
        </td>
      </tr>`;
  });

  document.getElementById("grandTotal").innerText = total;
}

function removeItem(i) {
  cart.splice(i, 1);
  renderCart();
}

document.getElementById("paymentMethod").onchange = e => {
  document.getElementById("qrisBox").style.display =
    e.target.value === "QRIS" ? "block" : "none";
};

document.getElementById("paid").oninput = () => {
  const paid = parseInt(document.getElementById("paid").value) || 0;
  const total = parseInt(document.getElementById("grandTotal").innerText);
  document.getElementById("change").innerText = paid - total;
};

document.getElementById("payBtn").onclick = () => {
  if (cart.length === 0) return alert("Keranjang kosong");

  const sales = DataStore.getSales();
  sales.push({
    date: new Date().toISOString(),
    items: cart,
    total: document.getElementById("grandTotal").innerText,
    payment: document.getElementById("paymentMethod").value
  });
  DataStore.saveSales(sales);

  alert("Transaksi tersimpan");
};

document.getElementById("printBtn").onclick = () => {
  setTimeout(() => window.print(), 300);
};
</script>

</body>
</html>
