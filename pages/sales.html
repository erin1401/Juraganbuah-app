<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Kasir | Juragan Buah POS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="../css/styles.css">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- CORE -->
<script src="../js/auth.js"></script>
<script src="../js/permissions.js"></script>
<script src="../js/cloud.js"></script>
<script src="../js/sidebar.js"></script>
</head>

<body>

<script>
Auth.requireLogin();
Permissions.requireRole(["admin","kasir"]);
</script>

<div class="app">

  <!-- SIDEBAR -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <img src="../assets/logo.png">
      <span>Juragan Buah</span>
    </div>
    <ul class="menu">
      <li><a href="dashboard.html">üè† Dashboard</a></li>
      <li><a class="active" href="sales.html">üßæ Kasir</a></li>
      <li><a href="#" onclick="Auth.logout()">üö™ Logout</a></li>
    </ul>
  </aside>

  <!-- CONTENT -->
  <main class="content">

    <header class="content-header">
      <button id="sidebarToggle">‚ò∞</button>
      <strong>Kasir</strong>
      <span id="currentUser"></span>
    </header>

    <!-- ===== KASIR LAYOUT ===== -->
    <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px">

      <!-- PRODUK -->
      <div class="card">
        <h4>Daftar Produk</h4>
        <table id="itemTable">
          <thead>
            <tr>
              <th>Item</th>
              <th>Harga</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- TRANSAKSI -->
      <div class="card">
        <h4>Transaksi</h4>

        <div id="cart"></div>

        <hr>

        <p>Total: <strong id="total">Rp 0</strong></p>

        <label>Metode Bayar</label>
        <select id="payMethod">
          <option value="Tunai">Tunai</option>
          <option value="QRIS">QRIS</option>
          <option value="Transfer">Transfer</option>
        </select>

        <label>Bayar</label>
        <input id="payAmount" type="number" placeholder="0">

        <p>Kembalian: <strong id="change">Rp 0</strong></p>

        <button class="btn btn-green" onclick="checkout()">üíæ Simpan & Cetak</button>
      </div>

    </div>
  </main>
</div>

<!-- ================= SCRIPT ================= -->
<script>
let items = [];
let cart = [];

CloudStore.getItems().then(data => {
  items = data;
  renderItems();
});

function renderItems() {
  const tbody = document.querySelector("#itemTable tbody");
  tbody.innerHTML = "";
  items.forEach(i => {
    tbody.innerHTML += `
      <tr>
        <td>${i.name}</td>
        <td>Rp ${i.price.toLocaleString("id-ID")}</td>
        <td><button class="btn btn-blue" onclick="addToCart('${i.id}')">+</button></td>
      </tr>
    `;
  });
}

function addToCart(id) {
  const item = items.find(i => i.id === id);
  const found = cart.find(c => c.id === id);

  if (found) {
    found.qty++;
  } else {
    cart.push({ ...item, qty: 1 });
  }
  renderCart();
}

function renderCart() {
  const div = document.getElementById("cart");
  div.innerHTML = "";
  let total = 0;

  cart.forEach(c => {
    total += c.qty * c.price;
    div.innerHTML += `
      <p>${c.name} x ${c.qty} = Rp ${(c.qty*c.price).toLocaleString("id-ID")}</p>
    `;
  });

  document.getElementById("total").innerText =
    "Rp " + total.toLocaleString("id-ID");

  document.getElementById("payAmount").oninput = () => {
    const bayar = Number(payAmount.value || 0);
    document.getElementById("change").innerText =
      "Rp " + (bayar - total).toLocaleString("id-ID");
  };
}

function checkout() {
  if (cart.length === 0) {
    alert("Keranjang kosong");
    return;
  }

  const total = cart.reduce((s,c)=>s+c.qty*c.price,0);
  const bayar = Number(payAmount.value || 0);
  if (bayar < total && payMethod.value === "Tunai") {
    alert("Uang kurang");
    return;
  }

  const sale = {
    items: cart,
    total,
    bayar,
    metode: payMethod.value,
    kasir: Auth.getUser().username
  };

  CloudStore.saveSale(sale);
  printStruk(sale);
  cart = [];
  renderCart();
}

function printStruk(sale) {
  const w = window.open("", "PRINT", "width=300,height=600");
  w.document.write(`
    <pre style="font-size:12px">
Juragan Buah
---------------------
${sale.items.map(i=>`${i.name} x${i.qty} ${i.price*i.qty}`).join("\n")}
---------------------
TOTAL : ${sale.total}
BAYAR : ${sale.bayar}
KEMBALI : ${sale.bayar-sale.total}
${sale.metode}
---------------------
Terima kasih
    </pre>
  `);
  w.document.close();
  w.focus();
  w.print();
  w.close();
}
</script>

</body>
</html>
