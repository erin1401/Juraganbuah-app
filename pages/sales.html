<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Penjualan | Juragan Buah</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="../css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="../assets/logo.png" />
      <span>Juragan Buah</span>
    </div>
    <nav class="menu">
      <a href="dashboard.html">Dashboard</a>
      <a href="items.html">Master Item</a>
      <a href="buyers.html">Pembeli</a>
      <a class="active" href="sales.html">Penjualan</a>
      <a href="report-sales.html">Laporan Penjualan</a>
      <a href="report-stock.html">Laporan Stok</a>
      <a href="report-profit.html">Laba Rugi</a>
    </nav>
  </aside>

  <!-- CONTENT -->
  <main class="content">

    <header class="content-header">
      <button id="sidebarToggle">â˜°</button>
      <h2>Kasir Penjualan</h2>
      <span id="currentUser"></span>
    </header>

    <div class="card">

      <label>Pilih Produk</label>
      <select id="productSelect"></select>

      <label>Qty</label>
      <input type="number" id="qty" value="1" min="1" />

      <button class="btn btn-green" onclick="addToCart()">Tambah</button>

    </div>

    <div class="card">
      <h3>Keranjang</h3>
      <table>
        <thead>
          <tr>
            <th>Produk</th>
            <th>Qty</th>
            <th>Harga</th>
            <th>Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="cartBody"></tbody>
      </table>
    </div>

    <div class="card">
      <label>Metode Pembayaran</label>
      <select id="payment">
        <option>Cash</option>
        <option>Transfer</option>
        <option>QRIS</option>
      </select>

      <label>Bayar</label>
      <input type="number" id="pay" />

      <h3>Total: <span id="grandTotal">Rp 0</span></h3>
      <h4>Kembalian: <span id="change">Rp 0</span></h4>

      <button class="btn btn-green" onclick="saveSale()">Simpan Transaksi</button>
    </div>

  </main>
</div>

<script>
/* ===============================
   PROTECT PAGE
================================ */
const user = JSON.parse(localStorage.getItem("currentUser"));
if (!user) location.href = "login.html";
document.getElementById("currentUser").innerText = user.name;

/* ===============================
   DATA
================================ */
const items = JSON.parse(localStorage.getItem("items")) || [];
const cart = [];

const productSelect = document.getElementById("productSelect");
items.forEach((i, idx) => {
  const opt = document.createElement("option");
  opt.value = idx;
  opt.textContent = i.name + " - Rp " + i.price;
  productSelect.appendChild(opt);
});

/* ===============================
   CART
================================ */
function addToCart() {
  const idx = productSelect.value;
  const qty = Number(document.getElementById("qty").value);
  const item = items[idx];

  cart.push({
    name: item.name,
    qty,
    price: item.price
  });

  renderCart();
}

function renderCart() {
  const body = document.getElementById("cartBody");
  body.innerHTML = "";

  let total = 0;

  cart.forEach((c, i) => {
    const tr = document.createElement("tr");
    const subtotal = c.qty * c.price;
    total += subtotal;

    tr.innerHTML = `
      <td>${c.name}</td>
      <td>${c.qty}</td>
      <td>Rp ${c.price.toLocaleString()}</td>
      <td>Rp ${subtotal.toLocaleString()}</td>
      <td><button onclick="removeItem(${i})">X</button></td>
    `;
    body.appendChild(tr);
  });

  document.getElementById("grandTotal").innerText =
    "Rp " + total.toLocaleString();

  const pay = Number(document.getElementById("pay").value || 0);
  document.getElementById("change").innerText =
    "Rp " + (pay - total).toLocaleString();
}

function removeItem(i) {
  cart.splice(i, 1);
  renderCart();
}

/* ===============================
   SAVE TRANSACTION
================================ */
function saveSale() {
  if (!cart.length) return alert("Keranjang kosong");

  const sales = JSON.parse(localStorage.getItem("sales")) || [];

  const total = cart.reduce((s, i) => s + i.qty * i.price, 0);

  sales.push({
    id: "TRX" + Date.now(),
    date: new Date().toISOString().slice(0, 10),
    items: cart,
    payment: document.getElementById("payment").value,
    total
  });

  localStorage.setItem("sales", JSON.stringify(sales));

  alert("Transaksi berhasil disimpan");
  location.reload();
}

/* ===============================
   SIDEBAR TOGGLE
================================ */
document.getElementById("sidebarToggle").onclick = () =>
  document.querySelector(".sidebar").classList.toggle("open");
</script>

</body>
</html>
