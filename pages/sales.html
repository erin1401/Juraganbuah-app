<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <title>Kasir POS | Juragan Buah</title>

  <link rel="stylesheet" href="../css/styles.css">
  <script src="../js/data.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/barcode.js"></script>
</head>

<body>

<!-- ================= TOPBAR ================= -->
<div class="topbar">
  <div class="logo">
    <img src="../assets/logo.png" alt="Juragan Buah">
    <strong>Juragan Buah â€” Kasir</strong>
  </div>
  <nav>
    <a href="dashboard.html">Dashboard</a>
    <a href="items.html">Item</a>
    <a href="buyers.html">Pembeli</a>
    <a href="sales.html" class="active">Penjualan</a>
    <a href="#" onclick="logout()">Logout</a>
  </nav>
</div>

<!-- ================= CONTENT ================= -->
<div class="container">

  <!-- BARCODE INPUT -->
  <div class="card">
    <h3>Scan / Input Barcode</h3>
    <input id="barcodeInput" placeholder="Masukkan barcode lalu Enter">
    <button type="button" class="btn btn-blue" id="scanBtn">Scan Kamera</button>

    <video id="camera" style="width:100%;display:none;margin-top:10px;"></video>
  </div>

  <!-- ADD ITEM MANUAL -->
  <div class="card">
    <h3>Tambah Produk</h3>
    <select id="itemSelect"></select>
    <input type="number" id="qty" value="1" placeholder="Qty">
    <button type="button" class="btn btn-green" id="addBtn">Tambah</button>
  </div>

  <!-- CART -->
  <div class="card">
    <h3>Keranjang</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Item</th>
          <th>Qty</th>
          <th>Harga</th>
          <th>Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="cartBody"></tbody>
    </table>
    <h3>Total: Rp <span id="grandTotal">0</span></h3>
  </div>

  <!-- PAYMENT -->
  <div class="card">
    <h3>Pembayaran</h3>

    <select id="paymentMethod">
      <option value="Cash">Cash</option>
      <option value="Transfer">Transfer</option>
      <option value="QRIS">QRIS</option>
    </select>

    <div id="qrisBox" style="display:none;text-align:center">
      <img src="../assets/qris.png" style="max-width:200px">
      <p>Scan QRIS</p>
    </div>

    <input type="number" id="paid" placeholder="Uang dibayar">
    <p>Kembalian: Rp <span id="change">0</span></p>

    <button type="button" class="btn btn-green btn-big" id="saveSale">Simpan Transaksi</button>
    <button type="button" class="btn btn-blue btn-big" id="printBtn">Print Struk</button>
  </div>

</div>

<!-- ================= SCRIPT ================= -->
<script>
let cart = [];
const items = DataStore.getItems();
const itemSelect = document.getElementById("itemSelect");
const cartBody = document.getElementById("cartBody");

items.forEach(i => {
  itemSelect.innerHTML += `<option value="${i.id}">${i.name} - Rp ${i.price}</option>`;
});

/* ADD MANUAL */
document.getElementById("addBtn").onclick = () => {
  const item = items.find(i => i.id === itemSelect.value);
  const qty = parseInt(qtyInput.value || 1);
  if (!item) return;
  addToCart(item, qty);
};

/* BARCODE INPUT */
document.getElementById("barcodeInput").addEventListener("keydown", e => {
  if (e.key === "Enter") {
    const item = BarcodeModule.findItemByBarcode(e.target.value);
    if (item) addToCart(item, 1);
    e.target.value = "";
  }
});

/* CAMERA SCAN */
document.getElementById("scanBtn").onclick = () => {
  const video = document.getElementById("camera");
  video.style.display = "block";

  BarcodeModule.startCamera(video, code => {
    const item = BarcodeModule.findItemByBarcode(code);
    if (item) addToCart(item, 1);
  });
};

/* CART LOGIC */
function addToCart(item, qty) {
  const found = cart.find(c => c.id === item.id);
  if (found) found.qty += qty;
  else cart.push({ id: item.id, name: item.name, price: item.price, qty });
  renderCart();
}

function renderCart() {
  cartBody.innerHTML = "";
  let total = 0;

  cart.forEach((c, i) => {
    const sub = c.qty * c.price;
    total += sub;
    cartBody.innerHTML += `
      <tr>
        <td>${c.name}</td>
        <td>${c.qty}</td>
        <td>${c.price}</td>
        <td>${sub}</td>
        <td>
          <button type="button" class="btn btn-red btn-sm" onclick="removeItem(${i})">X</button>
        </td>
      </tr>
    `;
  });

  document.getElementById("grandTotal").innerText = total;
}

function removeItem(i) {
  cart.splice(i, 1);
  renderCart();
}

/* PAYMENT */
document.getElementById("paymentMethod").onchange = e => {
  document.getElementById("qrisBox").style.display =
    e.target.value === "QRIS" ? "block" : "none";
};

document.getElementById("paid").oninput = () => {
  const paid = +paidInput.value || 0;
  const total = +grandTotal.innerText;
  document.getElementById("change").innerText = paid - total;
};

/* SAVE */
document.getElementById("saveSale").onclick = () => {
  if (!cart.length) return alert("Keranjang kosong");

  const sales = DataStore.getSales();
  sales.push({
    date: new Date().toISOString(),
    items: cart,
    total: +grandTotal.innerText,
    payment: paymentMethod.value
  });
  DataStore.saveSales(sales);

  alert("Transaksi tersimpan");
  cart = [];
  renderCart();
};

/* PRINT SAFE */
document.getElementById("printBtn").onclick = () => {
  setTimeout(() => window.print(), 300);
};
</script>

</body>
</html>
