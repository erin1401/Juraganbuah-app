<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Kasir | Juragan Buah</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="../css/styles.css">
</head>
<body>

<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="../assets/logo.png">
      <span>Juragan Buah</span>
    </div>
    <nav class="menu">
      <a href="dashboard.html">Dashboard</a>
      <a href="items.html">Master Item</a>
      <a href="buyers.html">Pembeli</a>
      <a class="active" href="sales.html">Penjualan</a>
      <a href="report-sales.html">Laporan Penjualan</a>
      <a href="report-stock.html">Laporan Stok</a>
      <a href="report-profit.html">Laba Rugi</a>
    </nav>
  </aside>

  <!-- CONTENT -->
  <main class="content">

    <header class="content-header">
      <button id="sidebarToggle">☰</button>
      <h2>Kasir Penjualan</h2>
      <span id="currentUser"></span>
    </header>

    <!-- INPUT PRODUK -->
    <div class="card">
      <label>Produk</label>
      <select id="productSelect"></select>

      <label>Qty</label>
      <input type="number" id="qty" value="1" min="1">

      <button class="btn btn-green" onclick="addToCart()">Tambah</button>
    </div>

    <!-- KERANJANG -->
    <div class="card">
      <h3>Keranjang</h3>
      <table>
        <thead>
          <tr>
            <th>Produk</th>
            <th>Qty</th>
            <th>Harga</th>
            <th>Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="cartBody"></tbody>
      </table>
    </div>

    <!-- PEMBAYARAN -->
    <div class="card">
      <label>Metode Pembayaran</label>
      <select id="payment">
        <option value="Cash">Cash</option>
        <option value="Transfer">Transfer</option>
        <option value="QRIS">QRIS</option>
      </select>

      <label>Bayar</label>
      <input type="number" id="pay" oninput="renderCart()">

      <h3>Total : <span id="grandTotal">Rp 0</span></h3>
      <h4>Kembalian : <span id="change">Rp 0</span></h4>

      <button class="btn btn-green" onclick="saveSale()">Simpan & Cetak</button>
    </div>

  </main>
</div>

<script>
/* ===============================
   PROTECT PAGE
================================ */
const user = JSON.parse(localStorage.getItem("currentUser"));
if (!user) location.href = "login.html";
document.getElementById("currentUser").innerText = user.name;

/* ===============================
   DATA
================================ */
const items = JSON.parse(localStorage.getItem("items")) || [];
const cart = [];

const productSelect = document.getElementById("productSelect");
items.forEach((item, index) => {
  const opt = document.createElement("option");
  opt.value = index;
  opt.textContent = item.name + " - Rp " + item.price.toLocaleString();
  productSelect.appendChild(opt);
});

/* ===============================
   CART FUNCTION
================================ */
function addToCart() {
  const idx = productSelect.value;
  const qty = Number(document.getElementById("qty").value);
  const item = items[idx];

  if (!item || qty <= 0) return;

  cart.push({
    name: item.name,
    qty: qty,
    price: item.price
  });

  renderCart();
}

function renderCart() {
  const body = document.getElementById("cartBody");
  body.innerHTML = "";

  let total = 0;

  cart.forEach((c, i) => {
    const subtotal = c.qty * c.price;
    total += subtotal;

    body.innerHTML += `
      <tr>
        <td>${c.name}</td>
        <td>${c.qty}</td>
        <td>Rp ${c.price.toLocaleString()}</td>
        <td>Rp ${subtotal.toLocaleString()}</td>
        <td>
          <button onclick="removeItem(${i})">✖</button>
        </td>
      </tr>
    `;
  });

  document.getElementById("grandTotal").innerText =
    "Rp " + total.toLocaleString("id-ID");

  const pay = Number(document.getElementById("pay").value || 0);
  const change = pay - total;

  document.getElementById("change").innerText =
    "Rp " + (change > 0 ? change : 0).toLocaleString("id-ID");
}

function removeItem(index) {
  cart.splice(index, 1);
  renderCart();
}

/* ===============================
   SAVE + PRINT
================================ */
function saveSale() {
  if (!cart.length) return alert("Keranjang kosong");

  const total = cart.reduce((s, i) => s + i.qty * i.price, 0);
  const pay = Number(document.getElementById("pay").value || 0);

  if (pay < total) return alert("Uang bayar kurang");

  const sales = JSON.parse(localStorage.getItem("sales")) || [];

  const invoice = {
    id: "TRX" + Date.now(),
    date: new Date().toLocaleString(),
    items: cart,
    payment: document.getElementById("payment").value,
    total: total,
    pay: pay,
    user: user.name
  };

  sales.push(invoice);
  localStorage.setItem("sales", JSON.stringify(sales));
  localStorage.setItem("lastInvoice", JSON.stringify(invoice));

  window.open("invoice.html", "_blank", "width=400,height=600");

  location.reload();
}

/* ===============================
   SIDEBAR MOBILE
================================ */
document.getElementById("sidebarToggle").onclick = () => {
  document.querySelector(".sidebar").classList.toggle("open");
};
</script>

</body>
</html>
