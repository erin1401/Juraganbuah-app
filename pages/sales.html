<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Kasir | Juragan Buah POS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="../css/styles.css">

<!-- CORE JS (URUTAN PENTING) -->
<script src="../js/auth.js"></script>
<script src="../js/data.js"></script>
<script src="../js/sidebar.js"></script>
</head>

<body>

<script>
Auth.requireLogin();
</script>

<div class="app">

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-header">
    <img src="../assets/logo.png" alt="logo">
    <span>Juragan Buah</span>
  </div>
  <ul class="menu">
    <li><a href="dashboard.html">üè† Dashboard</a></li>
    <li><a class="active" href="sales.html">üßæ Kasir</a></li>
    <li><a onclick="Auth.logout()">üö™ Logout</a></li>
  </ul>
</aside>

<!-- CONTENT -->
<main class="content">

<header class="content-header">
  <button id="sidebarToggle">‚ò∞</button>
  <strong>SUPER KASIR</strong>
  <span id="currentUser"></span>
</header>

<!-- POS LAYOUT -->
<div class="pos-layout">

  <!-- PRODUK -->
  <div class="card">
    <h3>Produk</h3>

    <input id="barcodeInput"
      placeholder="Scan / ketik barcode"
      style="width:100%;padding:10px;margin-bottom:10px">

    <table>
      <thead>
        <tr>
          <th>Nama</th>
          <th>Harga</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="productList">
        <tr><td colspan="3">Memuat data...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- KERANJANG -->
  <div class="card">
    <h3>Keranjang</h3>

    <div id="cartList">Keranjang kosong</div>

    <hr>

    <h2>Total: <span id="grandTotal">Rp 0</span></h2>

    <label>Metode Bayar</label>
    <select id="payMethod">
      <option value="Tunai">Tunai</option>
      <option value="QRIS">QRIS</option>
      <option value="Transfer">Transfer</option>
    </select>

    <label>Bayar</label>
    <input id="payAmount" type="number">

    <p>Kembali: <strong id="change">Rp 0</strong></p>

    <button class="btn btn-green" onclick="checkout()">
      üíæ BAYAR & CETAK
    </button>
  </div>

</div>
</main>
</div>

<!-- ================== SCRIPT ================== -->
<script>
let items = [];
let cart = [];

/* ===== LOAD MASTER ITEM ===== */
function loadItems() {
  const data = DataStore.getItems(); // dari data.js
  items = data || [];

  const tbody = document.getElementById("productList");
  tbody.innerHTML = "";

  if (!items.length) {
    tbody.innerHTML =
      `<tr><td colspan="3">Belum ada master item</td></tr>`;
    return;
  }

  items.forEach(i => {
    tbody.innerHTML += `
      <tr>
        <td>${i.name}</td>
        <td>Rp ${Number(i.price).toLocaleString("id-ID")}</td>
        <td>
          <button class="btn btn-blue" onclick="addToCart('${i.id}')">+</button>
        </td>
      </tr>
    `;
  });
}

/* ===== TAMBAH KE KERANJANG ===== */
function addToCart(id) {
  const item = items.find(i => i.id === id);
  if (!item) return alert("Item tidak ditemukan");

  const found = cart.find(c => c.id === id);
  if (found) found.qty++;
  else cart.push({ ...item, qty: 1 });

  renderCart();
}

/* ===== RENDER KERANJANG ===== */
function renderCart() {
  const div = document.getElementById("cartList");
  let total = 0;

  if (!cart.length) {
    div.innerHTML = "Keranjang kosong";
  } else {
    div.innerHTML = "";
    cart.forEach((c, i) => {
      const sub = c.qty * c.price;
      total += sub;
      div.innerHTML += `
        <div class="cart-row">
          <div>
            <strong>${c.name}</strong><br>
            Rp ${c.price.toLocaleString("id-ID")} x ${c.qty}
          </div>
          <div>
            <button onclick="changeQty(${i},-1)">‚àí</button>
            <button onclick="changeQty(${i},1)">+</button>
          </div>
        </div>
      `;
    });
  }

  document.getElementById("grandTotal").innerText =
    "Rp " + total.toLocaleString("id-ID");

  payAmount.oninput = () => {
    const bayar = Number(payAmount.value || 0);
    document.getElementById("change").innerText =
      "Rp " + (bayar - total).toLocaleString("id-ID");
  };
}

/* ===== QTY ===== */
function changeQty(i, delta) {
  cart[i].qty += delta;
  if (cart[i].qty <= 0) cart.splice(i,1);
  renderCart();
}

/* ===== BARCODE ===== */
barcodeInput.addEventListener("change", e => {
  const code = e.target.value.trim();
  const found = items.find(i => i.barcode === code);
  if (found) addToCart(found.id);
  e.target.value = "";
});

/* ===== CHECKOUT ===== */
function checkout() {
  if (!cart.length) return alert("Keranjang kosong");

  const total = cart.reduce((s,c)=>s+c.qty*c.price,0);
  const bayar = Number(payAmount.value||0);

  if (payMethod.value==="Tunai" && bayar < total)
    return alert("Uang kurang");

  const sale = {
    id: Date.now(),
    items: cart,
    total,
    bayar,
    metode: payMethod.value,
    kasir: Auth.getUser().username,
    waktu: new Date().toISOString()
  };

  DataStore.saveSale(sale);

  localStorage.setItem("printSale", JSON.stringify(sale));
  window.open("invoice.html","_blank");

  cart = [];
  renderCart();
}

/* INIT */
document.getElementById("currentUser").innerText =
  Auth.getUser().username;

loadItems();
</script>

<style>
.pos-layout {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 16px;
}
.cart-row {
  display:flex;
  justify-content:space-between;
  margin-bottom:8px;
}
@media(max-width:768px){
  .pos-layout{grid-template-columns:1fr}
}
</style>

</body>
</html>
