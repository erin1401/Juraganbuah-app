<!doctype html>
<html lang="id">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Item Keluar â€” Juragan Buah</title><link rel="stylesheet" href="styles.css"><script src="utils.js"></script><script src="data.js"></script></head>
<body>
  <div class="sidebar"><img src="assets/logo.svg" class="sidebar-logo"><div class="app-name">Juragan Buah</div><nav><a href="dashboard.html">Dashboard</a><a href="items.html">Master Item</a><a href="buyers.html">Pembeli</a><a href="stock-in.html">Item Masuk</a><a href="stock-out.html" class="active">Item Keluar</a><a href="opname.html">Stok Opname</a><a href="sales.html">Penjualan</a></nav></div>

  <div class="main">
    <header class="topbar"><h2>Item Keluar</h2></header>
    <div class="container">
      <div class="card"><div style="display:flex;gap:10px"><input id="so_search" placeholder="Cari..."><button class="btn" id="so_add">+ Catat Keluar</button></div>
      <table id="so_tbl" class="mt10"><thead><tr><th>Tgl</th><th>Item</th><th>Qty</th><th>Alasan</th></tr></thead><tbody></tbody></table></div>
    </div>
  </div>

<div id="modal" class="modal-bg"><div id="modalBox" class="modal-box"></div></div>
<div id="toast" class="toast"></div>

<script>
(function(){
  if(!DataStore.getLoginUser()) location.href='login.html';
  function render(){
    const rows = DataStore.getStockOut(); const items = DataStore.getItems();
    const kw = (so_search.value||'').toLowerCase(); const tb=document.querySelector('#so_tbl tbody'); tb.innerHTML='';
    rows.slice().reverse().filter(r=> (items.find(i=>i.id==r.itemId)?.name||'').toLowerCase().includes(kw)).forEach(r=>{
      const it=items.find(i=>i.id==r.itemId)||{name:'(terhapus)'}; const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.date}</td><td>${it.name}</td><td>${r.qty}</td><td>${r.reason||'-'}</td>`; tb.appendChild(tr);
    });
  }

  document.getElementById('so_add').onclick = ()=>{
    const items=DataStore.getItems(); if(items.length===0){ alert('Isi item dulu'); return; }
    const opts = items.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
    openModal(`<h3>Catat Barang Keluar</h3><label>Item</label><select id="so_item">${opts}</select><label>Qty</label><input id="so_qty" type="number" value="1"><label>Alasan</label><input id="so_reason"><label>Tanggal</label><input id="so_date" type="date" value="${today()}"><div style="text-align:right;margin-top:10px"><button class="btn" id="so_save">Simpan</button></div>`);
    setTimeout(()=> document.getElementById('so_save').onclick = ()=>{
      DataStore.addStockOut({ itemId: so_item.value, qty: Number(so_qty.value)||0, reason: so_reason.value||'', date: so_date.value||today() });
      closeModal(); toast('Dicatat'); render();
    },40);
  };

  window.openModal=function(html){ document.getElementById('modalBox').innerHTML = html; document.getElementById('modal').style.display='flex'; };
  window.closeModal=function(){ document.getElementById('modal').style.display='none'; };
  window.toast=function(m){ const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=> t.style.display='none',1800); };

  so_search.addEventListener('input', render);
  render();
})();
</script>
</body>
</html>
