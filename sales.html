<!doctype html>
<html lang="id">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Penjualan â€” Juragan Buah</title><link rel="stylesheet" href="styles.css"><script src="utils.js"></script><script src="data.js"></script></head>
<body>
  <div class="sidebar"><img src="assets/logo.svg" class="sidebar-logo"><div class="app-name">Juragan Buah</div><nav><a href="dashboard.html">Dashboard</a><a href="items.html">Master Item</a><a href="buyers.html">Pembeli</a><a href="stock-in.html">Item Masuk</a><a href="stock-out.html">Item Keluar</a><a href="opname.html">Stok Opname</a><a href="sales.html" class="active">Penjualan</a><a href="report-sales.html">Laporan</a></nav></div>

  <div class="main">
    <header class="topbar"><h2>Penjualan (POS)</h2></header>
    <div class="container">
      <div class="card">
        <div style="display:flex;gap:10px">
          <input id="scan" placeholder="Scan / ketik kode lalu Enter">
          <select id="selectItem"></select>
          <input id="qty" type="number" min="1" value="1" style="width:90px">
          <button class="btn" id="addCart">Tambah</button>
        </div>
      </div>

      <div class="card">
        <h3>Keranjang</h3>
        <table id="cart_tbl" class="mt10"><thead><tr><th>Item</th><th>Qty</th><th>Harga</th><th>Subtotal</th><th></th></tr></thead><tbody></tbody></table>
        <div style="text-align:right;margin-top:10px">Total: <strong id="total">Rp 0</strong></div>
      </div>

      <div class="card">
        <h3>Pembayaran</h3>
        <label>Metode</label>
        <select id="payMethod"><option value="cash">Tunai</option><option value="transfer">Transfer</option></select>
        <label>Jumlah Bayar</label><input id="pay" type="number" placeholder="0">
        <label>Kembalian</label><input id="change" readonly>
        <div style="display:flex;gap:8px;margin-top:10px"><button class="btn" id="process">Simpan & Cetak</button><button class="btn btn-outline" id="clearCart">Bersihkan</button></div>
      </div>
    </div>
  </div>

<div id="modal" class="modal-bg"><div id="modalBox" class="modal-box"></div></div>
<div id="toast" class="toast"></div>

<script>
(function(){
  if(!DataStore.getLoginUser()) location.href='login.html';
  const items = DataStore.getItems();
  const select = document.getElementById('selectItem');
  items.forEach(it=> select.appendChild(Object.assign(document.createElement('option'),{ value: it.id, textContent: `${it.name} (Rp ${Number(it.price).toLocaleString()})` })));
  let cart=[];

  function renderCart(){
    const tbody=document.querySelector('#cart_tbl tbody'); tbody.innerHTML=''; let total=0;
    cart.forEach((c,idx)=>{
      const item = DataStore.getItems().find(i=>i.id===c.id);
      const sub = item.price * c.qty; total += sub;
      const tr = document.createElement('tr'); tr.innerHTML=`<td>${item.name}</td><td><input type="number" value="${c.qty}" min="1" onchange="updateQty(${idx},this.value)"></td><td>${formatRupiah(item.price)}</td><td>${formatRupiah(sub)}</td><td><button class="btn btn-danger" onclick="removeCart(${idx})">X</button></td>`; tbody.appendChild(tr);
    });
    document.getElementById('total').innerText = formatRupiah(total);
  }

  window.updateQty=function(i,q){ cart[i].qty=Number(q); renderCart(); };
  window.removeCart=function(i){ cart.splice(i,1); renderCart(); };

  document.getElementById('addCart').onclick = ()=>{
    const id = select.value; const qty = Number(qty_input.value||document.getElementById('qty').value||1);
    const stock = DataStore.getStock(id);
    if(qty>stock){ toast('Stok kurang'); return; }
    const idx = cart.findIndex(x=>x.id===id);
    if(idx>=0) cart[idx].qty += qty; else cart.push({ id, qty });
    renderCart();
  };

  // scan enter
  document.getElementById('scan').addEventListener('keydown', e=>{
    if(e.key==='Enter'){ const v = e.target.value.trim(); if(!v) return; const found = DataStore.getItems().find(i => (i.code && i.code===v) || i.id===v || i.name.toLowerCase()===v.toLowerCase()); if(found){ select.value=found.id; addBtnClick(); } else toast('Item tidak ditemukan'); e.target.value=''; }
  });

  function addBtnClick(){
    const id = select.value; const q = Number(document.getElementById('qty').value||1);
    const stock = DataStore.getStock(id); if(q>stock){ toast('Stok kurang'); return; }
    const idx = cart.findIndex(x=>x.id===id);
    if(idx>=0) cart[idx].qty += q; else cart.push({ id, qty: q }); renderCart();
  }
  window.addBtnClick = addBtnClick;

  document.getElementById('clearCart').onclick = ()=>{ if(confirm('Kosongkan keranjang?')){ cart=[]; renderCart(); } };

  document.getElementById('pay').addEventListener('input', ()=> {
    const total = Number(document.getElementById('total').innerText.replace(/[^\d]/g,''))||0;
    const p = Number(document.getElementById('pay').value)||0;
    document.getElementById('change').value = p >= total ? 'Rp '+pTotal(p-total) : 'Kurang';
  });

  function pTotal(n){ return n.toLocaleString('id-ID'); }

  document.getElementById('process').onclick = ()=>{
    if(cart.length===0){ toast('Keranjang kosong'); return; }
    const total = Number(document.getElementById('total').innerText.replace(/[^\d]/g,''))||0;
    const pay = Number(document.getElementById('pay').value)||0;
    if(pay < total){ toast('Pembayaran kurang'); return; }
    const itemsPayload = cart.map(c=>({ itemId: c.id, qty: c.qty, price: DataStore.getItems().find(i=>i.id===c.id).price }));
    DataStore.addSale({ date: today(), items: itemsPayload, total: total, bayar: pay, kembali: pay-total, metode: document.getElementById('payMethod').value });
    // reduce stock
    itemsPayload.forEach(it => DataStore.addStockOut({ itemId: it.itemId, qty: it.qty, reason: 'Penjualan', date: today() }));
    toast('Transaksi tersimpan');
    // print simple receipt
    const sale = DataStore.getSales().slice(-1)[0];
    const win = window.open('','_blank'); win.document.write('<pre style="font-family:monospace">'); win.document.write('Juragan Buah\\n'); win.document.write('Invoice: '+sale.id+'\\n'); win.document.write('Tanggal: '+sale.date+'\\n\\n'); sale.items.forEach(it=> { const name=DataStore.getItems().find(i=>i.id===it.itemId).name; win.document.write(name+' x'+it.qty+' @'+formatRupiah(it.price)+' => '+formatRupiah(it.price*it.qty)+'\\n'); }); win.document.write('\\nTotal: '+formatRupiah(sale.total)+'\\nBayar: '+formatRupiah(sale.bayar)+'\\nKembali: '+formatRupiah(sale.kembali)+'\\n'); win.document.write('</pre>'); win.print(); win.close();
    cart=[]; renderCart();
  };

  renderCart();
})();
</script>
</body>
</html>
